<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Earlybird — Demo Frontend</title>
  <style>
    :root{
      --primary:#3b82f6;
      --bg:#ffffff;
      --muted:#6b7280;
      --card:#f8fafc;
      --radius:10px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    body{margin:0;background:#f3f4f6;color:#111827}
    header{background:var(--primary);color:white;padding:16px 20px}
    header h1{margin:0;font-size:18px}
    .container{max-width:980px;margin:20px auto;padding:0 16px}
    .layout{display:flex;gap:20px}
    .left{flex:1}
    .right{width:360px}
    .card{background:white;border-radius:var(--radius);padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:12px}
    .shop-item{display:flex;align-items:center;gap:12px;cursor:pointer;padding:10px;border-radius:8px}
    .shop-item:hover{background:var(--card)}
    .shop-title{font-weight:600}
    .product{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
    .product:last-child{border-bottom:none}
    .btn{background:var(--primary);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
    .cart-item{display:flex;justify-content:space-between;padding:6px 0}
    .slots-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .slot{border:1px solid #e6e9ee;padding:8px;border-radius:8px;text-align:center;cursor:pointer}
    .slot.selected{border:2px solid var(--primary);background:#eef6ff}
    .small{font-size:13px;color:var(--muted)}
    input[type="text"]{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
    footer{max-width:980px;margin:20px auto;padding:12px 16px;color:var(--muted);font-size:12px}
    .hidden{display:none}
    #tab-today.active,#tab-tomorrow.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .slot.disabled{opacity:0.45;pointer-events:none}
    .btn[disabled]{opacity:0.6;cursor:not-allowed}
  </style>
</head>
<body>
  <header><h1>Earlybird — Demo (Mülheim a.d. Ruhr)</h1></header>

  <div class="container">
    <div class="layout">
      <div class="left">
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <input id="search" type="text" placeholder="Filialen durchsuchen (z. B. Hemmerle)" />
            <button id="btn-refresh" class="btn ghost">Aktualisieren</button>
          </div>
          <div id="shops" class="shops"></div>
        </div>

        <div id="productsCard" class="card hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div id="shopName" style="font-weight:700"></div>
              <div id="shopAddress" class="small"></div>
            </div>
            <div><button id="btn-back" class="btn ghost">Zurück</button></div>
          </div>
          <div id="products"></div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Warenkorb</h3>
          <div id="cartList"></div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div class="small">Zwischensumme</div>
            <div id="cartTotal">0,00 €</div>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Abholzeit wählen</h4>
          <div style="margin-bottom:8px">
            <button id="tab-today" class="btn ghost">Heute</button>
            <button id="tab-tomorrow" class="btn ghost">Morgen</button>
          </div>
          <div id="slots" class="slots-grid"></div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px 0">Kontakt</h4>
          <input id="phone" type="text" placeholder="Telefonnummer (z. B. +49...)" />
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="btn-place" class="btn" style="flex:1" disabled>Bestellung absenden</button>
          </div>
          <div id="status" class="small" style="margin-top:8px;color:green"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Demo‑Frontend · Backend: http://localhost:3000</footer>

<script>
const API_BASE = 'http://localhost:3000';
let shops=[], products=[], currentShop=null, cart=[], slots={today:[],tomorrow:[],cutoff:'20:00'}, selectedSlot=null, currentTab='today';
const q = s => document.querySelector(s);
const money = v => Number(v||0).toFixed(2).replace('.',',') + ' €';

// Load shops
async function loadShops(){
  try {
    const r = await fetch(API_BASE + '/shops');
    shops = await r.json();
    renderShops();
  } catch(e){ alert('Fehler beim Laden der Shops: '+(e.message||e)); }
}

function renderShops(){
  const wrap = q('#shops'); wrap.innerHTML = '';
  const search = (q('#search')&&q('#search').value||'').toLowerCase();
  (shops||[]).filter(s => !search|| (s.name && s.name.toLowerCase().includes(search))).forEach(s=>{
    const el = document.createElement('div'); el.className='shop-item';
    el.innerHTML = `<div style="width:56px;height:56px;border-radius:8px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)">B</div>
      <div style="flex:1"><div class="shop-title">${s.name}</div><div class="small">${s.address||''}</div></div>`;
    el.onclick = ()=>openShop(s.id);
    wrap.appendChild(el);
  });
}

// open shop: load products + slots
async function openShop(shopId){
  try {
    const res = await fetch(API_BASE + '/products/by-shop/' + encodeURIComponent(shopId));
    products = await res.json();
    currentShop = shops.find(x=>x.id===shopId) || {id:shopId,name:shopId};
    q('#shopName').textContent = currentShop.name||shopId;
    q('#shopAddress').textContent = currentShop.address||'';
    const prodWrap = q('#products'); prodWrap.innerHTML='';
    (products||[]).forEach(p=>{
      const div = document.createElement('div'); div.className='product';
      div.innerHTML = `<div><div style="font-weight:600">${p.name}</div><div class="small">${(p.allergens||[]).join(', ')}</div></div>
        <div style="text-align:right"><div style="font-weight:600">${money(p.price)}</div><div style="margin-top:6px"><button class="btn" onclick="addToCart('${p.id}')">+</button></div></div>`;
      prodWrap.appendChild(div);
    });
    q('#productsCard').classList.remove('hidden');
    await loadSlots(shopId);
    selectedSlot = null; renderCart(); updateTabUI(); renderSlots();
  } catch(e){ console.error(e); alert('Produkte konnten nicht geladen werden: '+(e.message||e)); }
}

// loadSlots robust
async function loadSlots(shopId){
  try {
    const r1 = await fetch(API_BASE + '/slots/shops/' + encodeURIComponent(shopId) + '?date=today');
    const d1 = r1.ok ? await r1.json() : null;
    const r2 = await fetch(API_BASE + '/slots/shops/' + encodeURIComponent(shopId) + '?date=tomorrow');
    const d2 = r2.ok ? await r2.json() : null;
    const normalize = d => {
      if(!d) return [];
      if(Array.isArray(d)) return d;
      if(Array.isArray(d.slots)) return d.slots;
      for(const k of Object.keys(d)) if(Array.isArray(d[k])) return d[k];
      return [];
    };
    slots.today = normalize(d1); slots.tomorrow = normalize(d2);
    if(d1 && d1.cutoff) slots.cutoff = d1.cutoff;
  } catch(e){ console.error('Fehler beim Laden der Slots',e); slots.today=[]; slots.tomorrow=[]; }
}

// render slots
function renderSlots(){
  const container = q('#slots'); if(!container) return;
  const raw = currentTab==='today'?slots.today:slots.tomorrow;
  const arr = Array.isArray(raw)?raw:(raw&&raw.slots?raw.slots:[]);
  container.innerHTML='';
  if(!arr||arr.length===0){ container.innerHTML = '<div class="small">Keine Slots verfügbar</div>'; const pb=q('#btn-place'); if(pb){pb.disabled=true; pb.classList.add('ghost');} return;}
  arr.forEach(s=>{
    const el = document.createElement('div'); el.className='slot';
    const isFull = (s.capacity!==undefined && s.reserved!==undefined && s.reserved>=s.capacity);
    if(isFull) el.classList.add('disabled');
    if(selectedSlot && selectedSlot.id===s.id) el.classList.add('selected');
    el.innerHTML = `<div style="font-weight:600">${s.start} – ${s.end}</div><div class="small">${(s.reserved||0)}/${(s.capacity||'-')} belegt</div>`;
    el.addEventListener('click', ()=>{ if(isFull) return; selectedSlot=s; renderSlots(); });
    container.appendChild(el);
  });
  const pb=q('#btn-place'); if(pb){ if(selectedSlot){pb.disabled=false; pb.classList.remove('ghost');} else {pb.disabled=true; pb.classList.add('ghost');} }
}

// cart
function addToCart(productId){
  const p = products.find(x=>x.id===productId); if(!p) return;
  const existing = cart.find(i=>i.product_id===productId);
  if(existing) existing.qty++; else cart.push({product_id:productId,name:p.name,price:p.price,qty:1});
  renderCart();
}
function renderCart(){ const list=q('#cartList'); list.innerHTML=''; let total=0; cart.forEach((it,idx)=>{ total += it.price*it.qty; const el=document.createElement('div'); el.className='cart-item'; el.innerHTML=`<div>${it.name} x${it.qty}</div><div style="text-align:right"><div>${money(it.price*it.qty)}</div><div style="margin-top:6px"><button class="btn ghost" onclick="changeQty(${idx}, -1)">-</button><button class="btn" onclick="changeQty(${idx}, 1)">+</button></div></div>`; list.appendChild(el); }); q('#cartTotal').textContent = money(total); }
function changeQty(idx,delta){ cart[idx].qty += delta; if(cart[idx].qty<=0) cart.splice(idx,1); renderCart(); }

// place order
async function placeOrder(){
  if(!currentShop) return alert('Bitte erst eine Filiale auswählen.');
  if(cart.length===0) return alert('Warenkorb ist leer.');
  if(!selectedSlot) return alert('Bitte Abholzeit wählen.');
  const phone = q('#phone').value||null;
  const payload = { shop_id: currentShop.id, items: cart.map(i=>({product_id:i.product_id,qty:i.qty,price:i.price})), pickup_slot:selectedSlot.id, phone };
  try {
    q('#status').textContent = 'Sende Bestellung...';
    const res = await fetch(API_BASE + '/orders', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if(res.status===201 || data.id){ q('#status').textContent = 'Bestellung erfolgreich! ID: ' + (data.id||data.orderId); cart=[]; selectedSlot=null; renderCart(); renderSlots(); } else { q('#status').textContent = 'Fehler bei Bestellung: ' + (data.error || JSON.stringify(data)); }
  } catch(e){ q('#status').textContent = 'Netzwerkfehler: ' + e.message; }
}

// tabs
function updateTabUI(){ const tToday=q('#tab-today'), tTomorrow=q('#tab-tomorrow'); if(!tToday||!tTomorrow) return; if(currentTab==='today'){ tToday.classList.add('active'); tTomorrow.classList.remove('active'); } else { tTomorrow.classList.add('active'); tToday.classList.remove('active'); } }
const tabTodayBtn = document.querySelector('#tab-today'); const tabTomorrowBtn = document.querySelector('#tab-tomorrow');
if(tabTodayBtn) tabTodayBtn.onclick = ()=>{ currentTab='today'; updateTabUI(); renderSlots(); };
if(tabTomorrowBtn) tabTomorrowBtn.onclick = ()=>{ currentTab='tomorrow'; updateTabUI(); renderSlots(); };

// UI events
q('#btn-refresh')&&(q('#btn-refresh').onclick=()=>loadShops());
q('#search')&&(q('#search').oninput=()=>renderShops());
q('#btn-back')&&(q('#btn-back').onclick=()=>{ q('#productsCard').classList.add('hidden'); });
q('#btn-place')&&(q('#btn-place').onclick=placeOrder);
window.addToCart = addToCart; window.changeQty = changeQty;

// init
(async function init(){ updateTabUI(); await loadShops(); const defaultShop = shops.find(s=>s.id==='hemmerle'); if(defaultShop){ openShop(defaultShop.id); } })();
</script>
</body>
</html>
